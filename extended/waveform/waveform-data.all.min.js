/*! waveform-data.js - v1.0.0 - 2013-09-11
* Copyright (c) 2013 ; Licensed LGPL-3.0 */
"use strict";function WaveformData(a,b){this.adapter=b.fromResponseData(a),this.offset(0,this.adapter.length),this.segments={}}var WaveformData;WaveformData.prototype={offset:function(a,b){var c=this.adapter.length;if(0>b)throw new RangeError("End point must be non-negative.");if(a>=b)throw new RangeError("We can't end prior to the starting point.");if(0>a)throw new RangeError("Start point must be non-negative.");if(a>=c)throw new RangeError("Start point must be within range.");b>c&&(b=c),this.offset_start=a,this.offset_end=b,this.offset_length=b-a},set_segment:function(a,b,c){var d=this;return c=c||"default",this.segments[c]={start:a,end:b,get offset_start(){return this.start<d.offset_start&&this.end>d.offset_start?d.offset_start:this.start>=d.offset_start&&this.start<d.offset_end?this.start:null},get offset_end(){return this.end>d.offset_start&&this.end<=d.offset_end?this.end:this.end>d.offset_end&&this.start<d.offset_end?d.offset_end:null},get offset_length(){return this.offset_end-this.offset_start},get length(){return b-a},get visible(){return d.in_offset(this.start)||d.in_offset(this.end)||d.offset_start>this.start&&d.offset_start<this.end},get min(){return this.visible?d.offsetValues(this.offset_start,this.offset_length,0):[]},get max(){return this.visible?d.offsetValues(this.offset_start,this.offset_length,1):[]}},this.segments[c]},resample:function(a){"number"==typeof a&&(a={width:a});var b=[],c=a.scale||Math.floor(this.duration*this.adapter.sample_rate/a.width),d=this.adapter.scale,e=this.adapter.length,f=e?this.min_sample(0):0,g=e?this.max_sample(0):0,h=0,i=0,j=-128,k=127;if(d>c)throw new Error("Zoom level "+c+" too low, minimum: "+d);for(var l,m,n,o,p,q=function(a){return Math.floor(a*c)},r=function(a,c){b.push(a,c)};e>h;){for(;Math.floor(q(i)/d)===h;)i&&r(f,g),p=h,i++,l=q(i),m=q(i-1),l!==m&&(f=k,g=j);for(l=q(i),n=Math.floor(l/d),n>e&&(n=e);n>h;)o=this.min_sample(h),f>o&&(f=o),o=this.max_sample(h),o>g&&(g=o),h++}return h!==p&&r(f,g),new WaveformData({version:this.adapter.version,samples_per_pixel:c,length:b.length/2,data:b,sample_rate:this.adapter.sample_rate},WaveformData.adapters.object)},get min(){return this.offsetValues(this.offset_start,this.offset_length,0)},get max(){return this.offsetValues(this.offset_start,this.offset_length,1)},offsetValues:function(a,b,c){var d=this.adapter,e=Array.apply(null,new Array(b));return c+=2*a,e.map(function(a,b){return d.at(2*b+c)})},get duration(){return this.adapter.length*this.adapter.scale/this.adapter.sample_rate},get offset_duration(){return this.offset_length*this.adapter.scale/this.adapter.sample_rate},get pixels_per_second(){return this.adapter.sample_rate/this.adapter.scale},get seconds_per_pixel(){return this.adapter.scale/this.adapter.sample_rate},at:function(a){return this.adapter.at(a)},at_time:function(a){return Math.floor(a*this.adapter.sample_rate/this.adapter.scale)},time:function(a){return a*this.seconds_per_pixel},in_offset:function(a){return a>=this.offset_start&&a<this.offset_end},min_sample:function(a){return this.adapter.at(2*a)},max_sample:function(a){return this.adapter.at(2*a+1)}},WaveformData.adapters={},WaveformData.adapter=function(a){this.data=a},WaveformData.adapters.arraybuffer=function(a){this.data=a},WaveformData.adapters.arraybuffer.fromResponseData=function(a){return new WaveformData.adapters.arraybuffer(new DataView(a))},WaveformData.adapters.arraybuffer.prototype={get version(){return this.data.getInt32(0,!0)},get is_8_bit(){return!!this.data.getUint32(4,!0)},get is_16_bit(){return!this.is_8_bit},get sample_rate(){return this.data.getInt32(8,!0)},get scale(){return this.data.getInt32(12,!0)},get length(){return this.data.getUint32(16,!0)},at:function(a){return Math.round(this.data.getInt8(20+a))}},WaveformData.adapters.object=function(a){this.data=a},WaveformData.adapters.object.fromResponseData=function(a){return"string"==typeof a?new WaveformData.adapters.object(JSON.parse(a)):new WaveformData.adapters.object(a)},WaveformData.adapters.object.prototype={get version(){return this.data.version||1},get is_8_bit(){return 8===this.data.bits},get is_16_bit(){return!this.is_8_bit},get sample_rate(){return this.data.sample_rate},get scale(){return this.data.samples_per_pixel},get length(){return this.data.length},at:function(a){return Math.round(this.data.data[a])}},window.AudioContext=window.AudioContext||window.webkitAudioContext,WaveformData.adapters.arraybuffer.fromAudioObject=function(a,b){var c=new AudioContext,d=512,e=127;c.decodeAudioData(a,function(a){var c,f,g=Math.floor(a.length/d),h=20,i=new DataView(new ArrayBuffer(h+2*g)),j=1/0,k=-1/0,l=d,m=a.length;i.setInt32(0,1,!0),i.setUint32(4,1,!0),i.setInt32(8,a.sampleRate,!0),i.setInt32(12,d,!0),i.setInt32(16,g,!0),c=a.getChannelData(0),f=a.getChannelData(0);for(var n=0;m>n;n++){var o=(c[n]+f[n])/2*e;j>o&&(j=o),o>k&&(k=o),0===--l&&(i.setInt8(h++,Math.floor(j)),i.setInt8(h++,Math.floor(k)),j=1/0,k=-1/0,l=d)}b(new WaveformData(i.buffer,WaveformData.adapters.arraybuffer))})};